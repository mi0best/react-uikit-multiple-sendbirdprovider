'use strict';

var tslib_es6 = require('../../tslib.es6-c74b513f.js');
var React = require('react');
var LocalizationContext = require('../../LocalizationContext-58b6ed7c.js');
var CreateChannel_context = require('../../CreateChannelProvider-c3c843e4.js');
var useSendbirdStateContext = require('../../useSendbirdStateContext.js');
var ui_Modal = require('../../ui/Modal.js');
var ui_Label = require('../../index-b5a9b4b7.js');
var types = require('../../types-d0d770c3.js');
var ui_UserListItem = require('../../ui/UserListItem.js');
var utils = require('../../utils-eb6d90e0.js');
require('../../stringSet-1539ac47.js');
require('../../index-e8928da6.js');
require('../../sendbirdSelectors.js');
require('../../pubSub/topics.js');
require('../../withSendbird.js');
require('react-dom');
require('../../index-54279ec2.js');
require('../../index-b8ba4548.js');
require('../../MediaQueryContext-6141d955.js');
require('../../ui/IconButton.js');
require('../../ui/Button.js');
require('prop-types');
require('../../ui/Icon.js');
require('../../UserProfileContext-c6d7abb7.js');
require('../../ui/Avatar.js');
require('../../ui/ImageRenderer.js');
require('../../uuid-9a117e16.js');
require('../../ui/MutedAvatarOverlay.js');
require('../../ui/Checkbox.js');
require('../../ui/UserProfile.js');
require('../../ui/ContextMenu.js');
require('../../ui/SortByRow.js');
require('../../index-dbe8dd84.js');
require('../../utils/message/getOutgoingMessageState.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);

var filterUser = function (idsToFilter) {
  return function (currentId) {
    return idsToFilter === null || idsToFilter === void 0 ? void 0 : idsToFilter.includes(currentId);
  };
};
var setChannelType = function (params, type) {
  if (type === 'broadcast') {
    // eslint-disable-next-line no-param-reassign
    params.isBroadcast = true;
  }
  if (type === 'supergroup') {
    // eslint-disable-next-line no-param-reassign
    params.isSuper = true;
  }
  return params;
};
var createDefaultUserListQuery = function (_a) {
  var sdk = _a.sdk,
    userFilledApplicationUserListQuery = _a.userFilledApplicationUserListQuery;
  if (sdk === null || sdk === void 0 ? void 0 : sdk.createApplicationUserListQuery) {
    var params_1 = sdk === null || sdk === void 0 ? void 0 : sdk.createApplicationUserListQuery();
    if (userFilledApplicationUserListQuery) {
      Object.keys(userFilledApplicationUserListQuery).forEach(function (key) {
        params_1[key] = userFilledApplicationUserListQuery[key];
      });
    }
    return params_1;
  }
};

var appHeight = function () {
  try {
    var doc = document.documentElement;
    doc.style.setProperty('--sendbird-vh', window.innerHeight * 0.01 + 'px');
  } catch (_a) {
    //
  }
};
var BUFFER = 50;
var InviteUsers = function (_a) {
  var _b, _c, _d;
  var onCancel = _a.onCancel,
    userListQuery = _a.userListQuery;
  var _e = CreateChannel_context.useCreateChannelContext(),
    onBeforeCreateChannel = _e.onBeforeCreateChannel,
    onCreateChannel = _e.onCreateChannel,
    overrideInviteUser = _e.overrideInviteUser,
    createChannel = _e.createChannel,
    type = _e.type;
  var globalStore = useSendbirdStateContext.useSendbirdStateContext();
  var userId = (_b = globalStore === null || globalStore === void 0 ? void 0 : globalStore.config) === null || _b === void 0 ? void 0 : _b.userId;
  var sdk = (_d = (_c = globalStore === null || globalStore === void 0 ? void 0 : globalStore.stores) === null || _c === void 0 ? void 0 : _c.sdkStore) === null || _d === void 0 ? void 0 : _d.sdk;
  var idsToFilter = [userId];
  var _f = React.useState([]),
    users = _f[0],
    setUsers = _f[1];
  var _g = React.useState({}),
    selectedUsers = _g[0],
    setSelectedUsers = _g[1];
  var stringSet = React.useContext(LocalizationContext.LocalizationContext).stringSet;
  var _h = React.useState(null),
    usersDataSource = _h[0],
    setUsersDataSource = _h[1];
  var selectedCount = Object.keys(selectedUsers).length;
  var titleText = stringSet.MODAL__CREATE_CHANNEL__TITLE;
  var submitText = stringSet.BUTTON__CREATE;
  var userQueryCreator = userListQuery ? userListQuery() : createDefaultUserListQuery({
    sdk: sdk
  });
  React.useEffect(function () {
    var applicationUserListQuery = userQueryCreator;
    setUsersDataSource(applicationUserListQuery);
    // @ts-ignore
    if (!(applicationUserListQuery === null || applicationUserListQuery === void 0 ? void 0 : applicationUserListQuery.isLoading)) {
      applicationUserListQuery.next().then(function (users_) {
        setUsers(users_);
      });
    }
  }, []);
  // https://stackoverflow.com/a/70302463
  // https://css-tricks.com/the-trick-to-viewport-units-on-mobile/#css-custom-properties-the-trick-to-correct-sizing
  // to fix navbar break in mobile
  React.useEffect(function () {
    appHeight();
    window.addEventListener('resize', appHeight);
    return function () {
      window.removeEventListener('resize', appHeight);
    };
  }, []);
  return /*#__PURE__*/React__default["default"].createElement(ui_Modal.Modal, {
    isFullScreenOnMobile: true,
    titleText: titleText,
    submitText: submitText,
    type: types.ButtonTypes.PRIMARY
    // Disable the create button if no users are selected,
    // but if there's only the logged-in user in the user list,
    // then the create button should be enabled
    ,
    disabled: users.length > 1 && Object.keys(selectedUsers).length === 0,
    onCancel: onCancel,
    onSubmit: function () {
      var selectedUserList = Object.keys(selectedUsers).length > 0 ? Object.keys(selectedUsers) : [userId];
      if (typeof overrideInviteUser === 'function') {
        overrideInviteUser({
          users: selectedUserList,
          onClose: onCancel !== null && onCancel !== void 0 ? onCancel : utils.noop,
          channelType: type
        });
        return;
      }
      if (onBeforeCreateChannel) {
        var params = onBeforeCreateChannel(selectedUserList);
        setChannelType(params, type);
        createChannel(params).then(function (channel) {
          onCreateChannel === null || onCreateChannel === void 0 ? void 0 : onCreateChannel(channel);
        });
      } else {
        var params = {};
        params.invitedUserIds = selectedUserList;
        params.isDistinct = false;
        if (userId) {
          params.operatorUserIds = [userId];
        }
        setChannelType(params, type);
        // do not have custom params
        createChannel(params).then(function (channel) {
          onCreateChannel === null || onCreateChannel === void 0 ? void 0 : onCreateChannel(channel);
        });
      }
      onCancel === null || onCancel === void 0 ? void 0 : onCancel();
    }
  }, /*#__PURE__*/React__default["default"].createElement("div", null, /*#__PURE__*/React__default["default"].createElement(ui_Label.Label, {
    color: selectedCount > 0 ? ui_Label.LabelColors.PRIMARY : ui_Label.LabelColors.ONBACKGROUND_3,
    type: ui_Label.LabelTypography.CAPTION_1
  }, "".concat(selectedCount, " ").concat(stringSet.MODAL__INVITE_MEMBER__SELECTED)), /*#__PURE__*/React__default["default"].createElement("div", {
    className: "sendbird-create-channel--scroll",
    onScroll: function (e) {
      if (!usersDataSource) return;
      var eventTarget = e.target;
      var hasNext = usersDataSource.hasNext,
        isLoading = usersDataSource.isLoading;
      var fetchMore = eventTarget.clientHeight + eventTarget.scrollTop + BUFFER > eventTarget.scrollHeight;
      if (hasNext && fetchMore && !isLoading) {
        usersDataSource.next().then(function (usersBatch) {
          setUsers(tslib_es6.__spreadArray(tslib_es6.__spreadArray([], users, true), usersBatch, true));
        });
      }
    }
  }, users.map(function (user) {
    return !filterUser(idsToFilter)(user.userId) && /*#__PURE__*/React__default["default"].createElement(ui_UserListItem, {
      key: user.userId,
      user: user,
      checkBox: true,
      checked: selectedUsers[user.userId],
      onChange: function (event) {
        var _a;
        var modifiedSelectedUsers = tslib_es6.__assign(tslib_es6.__assign({}, selectedUsers), (_a = {}, _a[event.target.id] = event.target.checked, _a));
        if (!event.target.checked) {
          delete modifiedSelectedUsers[event.target.id];
        }
        setSelectedUsers(modifiedSelectedUsers);
      }
    });
  }))));
};

module.exports = InviteUsers;
//# sourceMappingURL=InviteUsers.js.map
