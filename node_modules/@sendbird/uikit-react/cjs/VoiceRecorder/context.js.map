{"version":3,"file":"context.js","sources":["../../../src/hooks/VoiceRecorder/index.tsx"],"sourcesContent":["import React, { createContext, useCallback, useContext, useEffect, useState } from 'react';\n\nimport { useLocalization } from '../../lib/LocalizationContext';\nimport Modal from '../../ui/Modal';\nimport {\n  BROWSER_SUPPORT_MIME_TYPE_LIST,\n  VOICE_MESSAGE_FILE_NAME,\n  VOICE_MESSAGE_MIME_TYPE,\n  VOICE_RECORDER_AUDIO_BIT_RATE,\n} from '../../utils/consts';\nimport useSendbirdStateContext from '../useSendbirdStateContext';\n\n// Input props of VoiceRecorder\nexport interface VoiceRecorderProps {\n  children: React.ReactElement;\n}\n\nexport interface VoiceRecorderEventHandler {\n  onRecordingStarted?: () => void;\n  onRecordingEnded?: (props: null | File) => void;\n}\n\n// Output of VoiceRecorder\nexport interface VoiceRecorderContext {\n  start: (eventHandler?: VoiceRecorderEventHandler) => void,\n  stop: () => void,\n  isRecordable: boolean;\n}\nconst noop = () => { /* noop */ };\nconst Context = createContext<VoiceRecorderContext>({\n  start: noop,\n  stop: noop,\n  isRecordable: false,\n});\n\nexport const VoiceRecorderProvider = (props: VoiceRecorderProps): React.ReactElement => {\n  const { children } = props;\n  const { config } = useSendbirdStateContext();\n  const { logger, isVoiceMessageEnabled } = config;\n  const [mediaRecorder, setMediaRecorder] = useState<MediaRecorder>(null);\n  const [isRecordable, setIsRecordable] = useState<boolean>(false);\n  const [permissionWarning, setPermissionWarning] = useState<boolean>(false);\n  const { stringSet } = useLocalization();\n\n  const checkPermission = () => {\n    try {\n      // Type '\"microphone\"' is not assignable to type 'PermissionName'.ts(2322)\n      // this is typescript issue\n      // https://github.com/microsoft/TypeScript/issues/33923\n      // @ts-expect-error\n      navigator.permissions.query({ name: 'microphone' }).then((result) => {\n        if (result.state === 'denied') {\n          logger.warning('VoiceRecorder: Permission denied.');\n          setPermissionWarning(true);\n        }\n      });\n    } catch (error) {\n      logger.warning('VoiceRecorder: Failed to check permission.', error);\n    }\n  };\n\n  const browserSupportMimeType = BROWSER_SUPPORT_MIME_TYPE_LIST.find((mimeType) => MediaRecorder.isTypeSupported(mimeType)) ?? '';\n  if (!browserSupportMimeType) {\n    logger.error('VoiceRecorder: Browser does not support mimeType', { mimmeTypes: BROWSER_SUPPORT_MIME_TYPE_LIST });\n  }\n\n  const [webAudioUtils, setWebAudioUtils] = useState(null);\n  useEffect(() => {\n    if (isVoiceMessageEnabled && !webAudioUtils) {\n      import('./WebAudioUtils').then((data) => {\n        setWebAudioUtils(data);\n      });\n    }\n  }, []);\n\n  const start = useCallback((eventHandler: VoiceRecorderEventHandler): void => {\n    if (isVoiceMessageEnabled && !webAudioUtils) {\n      logger.error('VoiceRecorder: Recording audio processor is being loaded.');\n      return;\n    }\n\n    logger.info('VoiceRecorder: Start recording.');\n    if (mediaRecorder) {\n      stop();\n      logger.info('VoiceRecorder: Previous mediaRecorder is stopped.');\n    }\n    checkPermission();\n    navigator?.mediaDevices?.getUserMedia?.({ audio: true })\n      .then((stream) => {\n        logger.info('VoiceRecorder: Succeeded getting media stream.', stream);\n        setIsRecordable(true);\n        const mediaRecorder = new MediaRecorder(stream, {\n          mimeType: browserSupportMimeType,\n          audioBitsPerSecond: VOICE_RECORDER_AUDIO_BIT_RATE,\n        });\n        mediaRecorder.ondataavailable = (e) => { // when recording stops\n          logger.info('VoiceRecorder: Succeeded getting an available data.', e.data);\n          const audioFile = new File([e.data], VOICE_MESSAGE_FILE_NAME, {\n            lastModified: new Date().getTime(),\n            type: VOICE_MESSAGE_MIME_TYPE,\n          });\n          webAudioUtils?.downsampleToWav(audioFile, (buffer) => {\n            const mp3Buffer = webAudioUtils?.encodeMp3(buffer);\n            const mp3blob = new Blob(mp3Buffer, { type: VOICE_MESSAGE_MIME_TYPE });\n            const convertedAudioFile = new File([mp3blob], VOICE_MESSAGE_FILE_NAME, {\n              lastModified: new Date().getTime(),\n              type: VOICE_MESSAGE_MIME_TYPE,\n            });\n            eventHandler?.onRecordingEnded(convertedAudioFile);\n            logger.info('VoiceRecorder: Succeeded converting audio file.', convertedAudioFile);\n          });\n          stream?.getAudioTracks?.().forEach?.(track => track?.stop());\n          setIsRecordable(false);\n        };\n        mediaRecorder?.start();\n        setMediaRecorder(mediaRecorder);\n        eventHandler?.onRecordingStarted();\n      })\n      .catch((err) => {\n        logger.error('VoiceRecorder: Failed getting media stream.', err);\n        setMediaRecorder(null);\n      });\n  }, [mediaRecorder, webAudioUtils]);\n\n  const stop = useCallback((): void => {\n    // Stop recording\n    mediaRecorder?.stop();\n    setMediaRecorder(null);\n    setIsRecordable(false);\n    logger.info('VoiceRecorder: Stop recording.');\n  }, [mediaRecorder]);\n\n  return (\n    <Context.Provider value={{\n      start,\n      stop,\n      isRecordable,\n    }}>\n      {children}\n      {\n        permissionWarning && (\n          <Modal\n            hideFooter\n            onCancel={() => setPermissionWarning(false)}\n          >\n            <>{stringSet.VOICE_RECORDING_PERMISSION_DENIED}</>\n          </Modal>\n        )\n      }\n    </Context.Provider>\n  );\n};\n\nexport const useVoiceRecorderContext = (): VoiceRecorderContext => useContext(Context);\n\nexport default {\n  VoiceRecorderProvider,\n  useVoiceRecorderContext,\n};\n"],"names":["noop","Context","createContext","start","stop","isRecordable","VoiceRecorderProvider","props","children","config","useSendbirdStateContext","logger","isVoiceMessageEnabled","_b","useState","mediaRecorder","setMediaRecorder","_c","setIsRecordable","_d","permissionWarning","setPermissionWarning","stringSet","useLocalization","checkPermission","navigator","permissions","query","name","then","result","state","warning","error","browserSupportMimeType","_a","BROWSER_SUPPORT_MIME_TYPE_LIST","find","mimeType","MediaRecorder","isTypeSupported","mimmeTypes","_e","webAudioUtils","setWebAudioUtils","useEffect","data","useCallback","eventHandler","info","mediaDevices","getUserMedia","audio","stream","audioBitsPerSecond","VOICE_RECORDER_AUDIO_BIT_RATE","ondataavailable","e","audioFile","File","VOICE_MESSAGE_FILE_NAME","lastModified","Date","getTime","type","VOICE_MESSAGE_MIME_TYPE","downsampleToWav","buffer","mp3Buffer","encodeMp3","mp3blob","Blob","convertedAudioFile","onRecordingEnded","getAudioTracks","call","forEach","track","onRecordingStarted","catch","err","React","createElement","Provider","value","Modal","hideFooter","onCancel","Fragment","VOICE_RECORDING_PERMISSION_DENIED","useVoiceRecorderContext","useContext"],"mappings":"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"}